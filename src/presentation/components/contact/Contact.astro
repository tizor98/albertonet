---
import { getLangFromUrl, useTranslations } from "@/config/i18n/utils";
import DefaultButton from "../ui/DefaultButton.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section
    class="w-full px-10 mt-18 flex items-start justify-center"
>
    <form
        id="contact-form"
        class="w-full max-w-xl flex flex-col gap-5 mt-5 lg:mt-10 adaptive-text ui-card p-6 md:p-8"
        novalidate
    >
        <div class="flex flex-col gap-1.5">
            <label class="custom-label" for="name">{t("contact.name")}</label>
            <input
                id="name"
                class="custom-input"
                name="name"
                type="text"
                placeholder={t("contact.name")}
                required
                aria-invalid="false"
            />
            <p id="name-error" class="custom-field-error" data-visible="false"></p>
        </div>
        <div class="flex flex-col gap-1.5">
            <label class="custom-label" for="email">{t("contact.email")}</label>
            <input
                id="email"
                class="custom-input"
                name="email"
                type="email"
                placeholder={t("contact.email")}
                required
                aria-invalid="false"
            />
            <p id="email-error" class="custom-field-error" data-visible="false"></p>
        </div>
        <div class="flex flex-col gap-1.5">
            <label class="custom-label" for="message">{t("contact.message")}</label>
            <textarea
                id="message"
                class="custom-text-area"
                name="message"
                minlength=10
                placeholder={t("contact.message")}
                required
                aria-invalid="false"
            ></textarea>
            <p id="message-error" class="custom-field-error" data-visible="false"></p>
        </div>
        <div class="w-full flex gap-3 items-center justify-between">
            <label class="custom-label" for="isCompany">{t("contact.isCompany")}</label>
            <input
                class="toggle text-gray-600 checked:text-gray-200 border-2 border-zinc-800 dark:border-zinc-200"
                type="checkbox"
                id="isCompany"
                name="isCompany"
            />
        </div>
        <div id="errors" class="text-red-500 flex flex-col gap-0 text-sm tracking-tight">
        </div>
        
        <DefaultButton id="contact-button" type="submit" class="uppercase cursor-pointer" data-default-label={t("generic.send")}>
            {t("generic.send")}
        </DefaultButton>
    </form>
    <div id="error-toast" class="hidden toast transition-all duration-1000 ease-in-out">
        <div class="alert alert-error">
            <span class="text-black font-semibold">{t("error.internalError")}</span>
        </div>
    </div>
</section>

<script>
import { availableLanguages, DEFAULT_LANG } from "@/config/i18n/messages";
import { paths } from "@/config/paths";
import { actions} from "astro:actions";
import { navigate } from "astro:transitions/client";

const form = document.getElementById("contact-form") as HTMLFormElement;
const errors = document.getElementById("errors") as HTMLDivElement;
const fieldIds = ["name", "email", "message"] as const;

if (form && errors) {
    document.addEventListener("submit", e => {
        e.preventDefault();
        sendForm(form, errors);
    });
}

async function sendForm(form: HTMLFormElement, errors: HTMLDivElement) {
    try {
        clearErrors(form, errors);

        showLoading(true);
        const formData = new FormData(form);
        const response = await actions.sendNotification(formData);

        if (response.error?.code === "BAD_REQUEST") {
            const issues = response.error.message.split(";").map((issue) => {
                const p = document.createElement("p");
                p.textContent = issue;
                return p;
            });
            applyFieldErrors(response.error.message.split(";").map((issue) => issue.trim()));
            errors.append(...issues);
            return;
        }

        if (response.error) {
            showErrorModal();
            return;
        }

        redirectToSendConfirmation();
    } catch (error) {
        console.error(error);
        showErrorModal();
    } finally {
        showLoading(false);
    }
}

function clearErrors(form: HTMLFormElement, errors: HTMLDivElement) {
    for (const fieldId of fieldIds) {
        const field = form.elements.namedItem(fieldId) as HTMLInputElement | HTMLTextAreaElement | null;
        const fieldError = document.getElementById(`${fieldId}-error`);
        if (field) {
            field.classList.remove("custom-input-error", "custom-text-area-error");
            field.setAttribute("aria-invalid", "false");
        }
        if (fieldError) {
            fieldError.textContent = "";
            fieldError.setAttribute("data-visible", "false");
        }
    }

    if (!errors.hasChildNodes()) return;
    const maxIterations = 100;
    let iterations = 0;
    
    while (errors.hasChildNodes() && iterations < maxIterations) {
        const node = errors.firstChild;
        if (node) errors.removeChild(node);
        iterations++;
    }
}

function applyFieldErrors(issues: string[]) {
    const messageForField: Record<string, string | undefined> = {
        name: undefined,
        email: undefined,
        message: undefined,
    };

    for (const issue of issues) {
        const normalized = issue.toLowerCase();
        if (
            normalized.includes("name")
            || normalized.includes("nombre")
        ) {
            messageForField.name = issue;
        }
        if (
            normalized.includes("email")
            || normalized.includes("correo")
            || normalized.includes("mail")
        ) {
            messageForField.email = issue;
        }
        if (
            normalized.includes("message")
            || normalized.includes("mensaje")
        ) {
            messageForField.message = issue;
        }
    }

    for (const fieldId of fieldIds) {
        const field = document.getElementById(fieldId) as HTMLInputElement | HTMLTextAreaElement | null;
        const fieldError = document.getElementById(`${fieldId}-error`);
        const issue = messageForField[fieldId];
        if (!field || !fieldError || !issue) continue;

        field.classList.add(fieldId === "message" ? "custom-text-area-error" : "custom-input-error");
        field.setAttribute("aria-invalid", "true");
        fieldError.textContent = issue;
        fieldError.setAttribute("data-visible", "true");
    }
}

function showErrorModal() {
    const toast = document.getElementById("error-toast");
    if (toast) {
        let timeout = null;
        try {
            toast.classList.remove("hidden");
            timeout = setTimeout(() => {
                toast.classList.add("hidden");
            }, 1500)
        } catch {
            if (timeout) {
                clearTimeout(timeout);
                timeout = null;
            }
            if (toast) {
                toast.classList.add("hidden");
            }
        }
    }
}

function redirectToSendConfirmation() {
    let localStorageLang: string | null = localStorage.getItem("lang") ?? "";
    localStorageLang = availableLanguages.includes(localStorageLang) ? localStorageLang : null;
    const lang = localStorageLang ?? DEFAULT_LANG;
    navigate(paths.contactSend(lang));
}

function showLoading(show: boolean) {
    const button = document.getElementById("contact-button");
    if (!(button instanceof HTMLButtonElement)) return;
    const label = button.getAttribute("data-default-label") ?? "Send";

    if (show) {
        button.setAttribute("disabled", "true");
        button.setAttribute("aria-busy", "true");
        button.textContent = `${label}...`;
        return;
    }

    button.removeAttribute("disabled");
    button.setAttribute("aria-busy", "false");
    button.textContent = label;
}
</script>
